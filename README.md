# Music Blocks JavaScript Export

This is a description of my work on [Music Blocks JavaScript Export](https://summerofcode.withgoogle.com/projects/#5876019535282176) during *Google Summer of Code 2020* with
[Sugar Labs](https://github.com/sugarlabs/). This repository contains my
original authored files, samples of my work, and examples.

## Abstract

The aim of Music Blocks is to teach beginners how to program, using a
snap-together block-based instructions to create music. The purpose of my
project is to develop a framework to export any Music Blocks program to an
equivalent JavaScript code, and/or write Music Blocks programs using JavaScript,
either of which can run independently of the blocks.

## Tech Stack

I've used **JavaScript** upto the **ECMAScript 8 (2017)** specification widely
relying on *ES6* `classes`, `let`/`const`, `arrow functions`, `promises`, and
finally, `async`/`await` syntactical feature from *ES8*. In the implementation
of a new *Music Blocks* widget - *JavaScript Editor*, I required the use of
**HTML** and **CSS**, but I used the *DOM* manipulation features of JavaScript
to handle those.

In addition, for the actual code generation part of the project, I relied on a
library named **[Astring](https://github.com/davidbonnet/astring)**
(*MIT License*), which is a "*Tiny and fast JavaScript code generator from an ESTree-compliant AST*".
I generated *Abstact Syntax Trees* (*AST*s) based on the **ESTree ES2017**
specification, which I serialized to *ES8* JavaScript code using the library.

Finally, I relied on a library named **[CodeJar](https://github.com/antonmedv/codejar)**
(*MIT License*), which is "*an embeddable code editor for the browser*". I used
it to create a text editor inside my widget, and a styling library named
**[Highlight.js](https://github.com/highlightjs/highlight.js/)**
(*BSD-3-Clause License*) for syntax highlighting.

## Work Progression

During the *community bonding period* I started with refactoring some of the
crucial files to *ES6* standard: completed refactoring `var` to `let` and
`const`, implementing `arrow` functions, and refactoring `function prototype`
syntax to *ES6* `classes`.

Even though my project was an independent feature addition, it was imperative
that I refactored and reorganised the different components of Music Blocks under
the hood. Therefore, I progressed in small steps splitting the task across
multiple PRS. Throughout the three months of the *coding period* (post release
[v3.1](https://github.com/sugarlabs/musicblocks/releases/tag/v3.1)), I have *51*
merged *Pull Requests* ([copy of PRs](https://github.com/meganindya/musicblocks/pulls?q=label%3A%22GSoC+2020%22+)) across *240* commits.

My work, basically, consisted of four major parts:
*Restructuring the components*, *Building the JavaScript coding framework*,
*Generating code from block stacks*, and *Building the JavaScript Code Editor*.
Since, the restructuring was not possible to do linearly, I did it in multiple
turns.

### Restructuring the components

When I started `logo.js` was somewhat monolithic, consisting of code that was
part of different components. As I progressed, I created two new components:
`Painter` and `Singer`, in two new files `turtle-painter.js` and
`turtle-singer.js`, respectively. These two components are now subcomponents of
the `Turtle` component in `turtle.js`. `Painter` contains code related to the
"art" generated by the *turtle* (*mouse*), while the `Singer` deals with "music
generation". The `Turtles` component was separated to a new file named
`turtles.js`, which now totally oversees alone all `Turtle` objects.

Below listed are the major contributions related to restructing and refactoring
the said components.

- **`logo.js`**

  - Ported out code related to processing *notes* to `js/note.js`, encapsulating
  those in a new `class` named `NoteController`.
  ([PR 2295](https://github.com/sugarlabs/musicblocks/pull/2295))

  - Converted the `function prototype` definition of `Logo` to *ES6* `class` and
  added *ES6* `getters` and `setters` for instance variables.
  ([PR 2298](https://github.com/sugarlabs/musicblocks/pull/2298))

  - Ported out code related to *notations* to `js/notation.js`, encapsulating
  those in a new `class` named `Notation`.
  ([PR 2356](https://github.com/sugarlabs/musicblocks/pull/2356))

  - Ported out utilities related to mathematical calculations to
  `js/utils/mathutils.js`, encapsulating those in a new `class` named
  `MathUtility`.
  ([PR 2357](https://github.com/sugarlabs/musicblocks/pull/2357))

  - Ported out some functions related to *blocks* to `js/blocks.js`.
  ([PR 2358](https://github.com/sugarlabs/musicblocks/pull/2358))

  - Reorganized and renamed members, and cleaned up code.
  ([PR 2393](https://github.com/sugarlabs/musicblocks/pull/2393))

  - Ported out utility functions related to music logic to `Singer` (`note.js`
  was rebranded as `turtle-singer.js`, and `NoteController` as `Singer`) in
  `turtle-singer.js`
  ([PR 2407](https://github.com/sugarlabs/musicblocks/pull/2407))

  - Ported out variables related to music *state* to `Turtle`/`Singer`.
  ([PR 2408](https://github.com/sugarlabs/musicblocks/pull/2408),
  [PR 2418](https://github.com/sugarlabs/musicblocks/pull/2408),
  [PR 2425](https://github.com/sugarlabs/musicblocks/pull/2425),
  [PR 2432](https://github.com/sugarlabs/musicblocks/pull/2432),)

- **`turtle.js`**

  - Reorganized and renamed members, and cleaned up code.
  ([PR 2304](https://github.com/sugarlabs/musicblocks/pull/2304))

  - Set up the **Model-View-Controller (MVC)** framework for the `Turtle`
  component.
  ([PR 2312](https://github.com/sugarlabs/musicblocks/pull/2312))

  - Reworked variable access.
  ([PR 2316](https://github.com/sugarlabs/musicblocks/pull/2312))

- **`turtles.js`**

  - Separated the `Turtles` component from `turtle.js` to `turtles.js` and set
  up the **Model-View-Controller (MVC)** framework for it.
  ([PR 2309](https://github.com/sugarlabs/musicblocks/pull/2309))

  - Removed deprecated code and reworked variable access.
  ([PR 2313](https://github.com/sugarlabs/musicblocks/pull/2313),
  [PR 2341](https://github.com/sugarlabs/musicblocks/pull/2341))

  - Improved modularity.
  ([PR 2384](https://github.com/sugarlabs/musicblocks/pull/2374))

- **`turtle-painter.js`**

  - Created `Turtle`'s subcomponent `Painter` in `turtle-painter.js`.
  ([PR 2382](https://github.com/sugarlabs/musicblocks/pull/2382))

- **`turtle-singer.js`**

  - Rebranded `note.js` to `turtle-singer.js`, and `NoteController` component
  `class` to `Singer`.
  ([PR 2397](https://github.com/sugarlabs/musicblocks/pull/2397))

### Building the JavaScript coding Framework

I created a framework to setup the JavaScript code-based Music Blocks programs.
All the code realting to the framework's operation is now present in the
`js/js-export/` directory. The framework consists of an API of `methods`
corresponding to different *blocks*' instructions. I conceptualized a standard
syntax, based on which the JavaScript programs are to be written in.

The `export.js` contains two components: `Mouse` and `MusicBlocks`. `Mouse` is
an excapsulation for the `Turtle` component, which `MusicBlocks` deals with all
operational behavior of the framework. Since, Music Blocks (`Logo` component)
programs heavily rely on asynchronous `events` like `setTimeout`, it was a big
challenge to come up with a mechanism to present a synchronous appearance in the
"exported" code. Beneath the hood, the framework heavily relies on *ES6*
`promises`. I used the "syntactic sugar" of *ES8* `async`/`await` to cover up
the `.then()` chaining of `promises`. In the end, the code looks quite
synchronous and clean.

Yet more refactoring was required to connect the API ends to their behaviour.
Most of the *block behavior* was present in the `block API` in the `js/blocks/`
directory. The behavior related to "art" generation is present in the `Painter`
component with `methods` for each. The "music" behavior had to be extracted out.
I created a new directory `js/turtleactions/` and separated out the *behaviour*
code from the *block* code. Each of the "music" palettes now have their own
*action* file which deal with their behavior, a method each for each block.
Finally, I created a directory `js/js-export/API/` having files corresponding to
each *palette*; each file contains `methods` that are to be used in the
"exported" code, which are internally linked to corresponding *behaviour*
methods in `js/turtleactions/`.

Below listed are the major contributions related to the said work.

  - Conceptualized the "framework" and tested for *Graphics* and *Pen* palette
  blocks.
  ([PR 2380](https://github.com/sugarlabs/musicblocks/pull/2380))

  - Ported code related to behavior of *Rhythm* blocks.
  ([PR 2497](https://github.com/sugarlabs/musicblocks/pull/2497))

  - Ported code related to behavior of *Meter* blocks.
  ([PR 2536](https://github.com/sugarlabs/musicblocks/pull/2536))

  - Ported code related to behavior of *Pitch* blocks.
  ([PR 2454](https://github.com/sugarlabs/musicblocks/pull/2454))

  - Ported code related to behavior of *Intervals* blocks.
  ([PR 2504](https://github.com/sugarlabs/musicblocks/pull/2504))

  - Ported code related to behavior of *Tone* blocks.
  ([PR 2480](https://github.com/sugarlabs/musicblocks/pull/2480))

  - Ported code related to behavior of *Ornament* blocks.
  ([PR 2471](https://github.com/sugarlabs/musicblocks/pull/2471))

  - Ported code related to behavior of *Volume* blocks.
  ([PR 2476](https://github.com/sugarlabs/musicblocks/pull/2474))

  - Ported code related to behavior of *Drum* blocks.
  ([PR 2477](https://github.com/sugarlabs/musicblocks/pull/2477))

  - Created the API files.
  ([PR 2508](https://github.com/sugarlabs/musicblocks/pull/2508))

  - Set up the timing of events.
  ([PR 2511](https://github.com/sugarlabs/musicblocks/pull/2511))

  - Add argument validation.
  ([PR 2547](https://github.com/sugarlabs/musicblocks/pull/2547))

### Generating code from block stacks

I used a library called **`Astring`** to generate required "exported" JavaScript
code. The library takes `ESTree`-spec *Abstract Syntax Trees* (*ASTs*) as input.
Therefore, my work was to generate the *ASTs* from the block stacks. Internally,
*Music Blocks* maintains a linear list of `Block` objects which are linked
amongst themselves via their indices in the list. Since, handing the nesting of
the stacks in that manner would have been a difficult process, I generated a
non-linear tree-like recursive structure by parsing the *start* and *action*
block stacks. The arguments to blocks can get chained horizontally, and so, the
structure had to deal with that too.

After the non-linear data-structure generation was handled, I mechanised an
algorithm to parse that recursive structure to generate a recursive `JSON`
object representing the *Abstract Syntax Tree* in the `ESTree` `ES2017`
specification. The code could then be generated by the `generate()` function of
the `Astring` library.

All the code related to the data-structure and code generation is in
`generate.js`, encapsulated in the `JSGenerate` class. All the utilities related
to generation of the *ASTs* are in `ASTutils.js`, encapsulated in the `ASTUtils`
class. `JSInterface` in `interface.js` contains lists and lookups of `Block`
names and *API* `methods`', `getters`', and `setters`' names. It also contains
the utilities related to the API's *argument validation*.

Below listed is the Pull Request related to the code generation.

  - Added the mechanism to generate the tree-like data-structure, AST from it,
  and the final code.
  ([PR 2525](https://github.com/sugarlabs/musicblocks/pull/2525))

### Building the JavaScript Code Editor

I created a new widget named **JavaScript Editor** which has a *syntax-highlighted*
`text-box` and a `console` to print messages during execution. The widget is
generated by using the `DOM` manipulation features of JavaScript. The widget
deals with displaying the generated code, editing/writing new code, and running
the JavaScript-based Music Blocks programs.

Below listed are the contributions related to the JavaScript Editor Widget.

  - Built the initial widget design.
  ([PR 2489](https://github.com/sugarlabs/musicblocks/pull/2489))

  - Add robustness features and failsafes mechanisms related to multiple *Mice*
  (*Mouse* objects).
  ([PR 2514](https://github.com/sugarlabs/musicblocks/pull/2514))

  - Enhance the editor.
  ([PR 2547](https://github.com/sugarlabs/musicblocks/pull/2547))
